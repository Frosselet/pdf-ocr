# Data Contract: Russian Ministry of Agriculture — Weekly Grain Reports
#
# This contract drives a generic 4-step pipeline (prepare → fetch → transform → save).
# All pipeline logic is standard; differentiation lives here in the contract.

provider: ru_ag_ministry
description: Russian Ministry of Agriculture weekly grain reports

model: openai/gpt-4o

# --- How to extract report_date from the filename ---
# Captures e.g. "June 20-21" from "...EOW June 20-21 2025-1.docx"
report_date_pattern: "(?:EOW\\s+)?([A-Z][a-z]+ \\d+-\\d+)"

# --- Table classification rules ---
# Keywords are matched case-insensitively against table headers.
categories:
  harvest:
    keywords:
      - area harvested
      - yield
      - collected
      - bunker
      - centner
      - harvested area
      - crop harvested
  planting:
    keywords:
      - spring crops
      - moa target
      - spring wheat
      - spring barley
      - sown area
      - planting
      - sowing
      - planted
      - corn
      - rice
      - sunflower
      - soya
      - rape
      - buckwheat
  export:
    keywords:
      - export
      - shipment
      - ports
      - fob
      - vessel
      - cargo

# --- Output table definitions ---
# Each output maps a classification category to a target parquet schema.
#
# Column source types:
#   (no source)     → LLM-extracted via CanonicalSchema + aliases
#   source: title   → filled from the DOCX table title
#   source: report_date → filled from the filename-derived report date
#   source: constant    → filled with a fixed value (see "value" key)
#
# dynamic_aliases: pivot → Year aliases auto-detected from table headers
#                          via extract_pivot_values()

outputs:
  harvest:
    category: harvest
    filename: harvest.parquet
    schema:
      description: "Harvest progress by region, metric, and year"
      columns:
        - name: Region
          type: string
          description: "Geographic region or district"
          aliases: [Region]
        - name: Report_date
          type: string
          description: "Reporting period label"
          source: report_date
        - name: Crop
          type: string
          description: "Crop name"
          source: title
        - name: Campaign
          type: string
          description: "Campaign type"
          source: constant
          value: HARVESTING
        - name: Metric
          type: string
          description: "Measurement type"
          aliases: ["Area harvested", "collected", "Yield"]
        - name: Value
          type: float
          description: "Numeric value for the metric"
        - name: Year
          type: int
          description: "Reporting year"
          dynamic_aliases: pivot

  planting:
    category: planting
    filename: planting.parquet
    schema:
      description: "Planting/sowing progress by region and crop"
      columns:
        - name: Region
          type: string
          description: "Geographic region or district"
          aliases: [Region]
        - name: Area
          type: float
          description: "MoA target planting area (Th.ha.)"
          aliases: ["MOA Target"]
        - name: Value
          type: float
          description: "Actual sown area (Th.ha.)"
        - name: Crop
          type: string
          description: "Crop name"
        - name: Report_date
          type: string
          description: "Reporting period label"
          source: report_date
        - name: Year
          type: int
          description: "Reporting year"
          dynamic_aliases: pivot
